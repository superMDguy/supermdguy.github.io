<script
    src="{{ "/js/plotly.min.js" | relURL }}"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
></script>
<script
    src="{{ "/js/jstat.min.js" | relURL }}"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
></script>

<div id="price-viz">
    <style>
        #price-viz {
            border: 1px solid #ccc;
            padding: 20px;
            max-width: 900px;
        }
        .controls-container {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .value {
            min-width: 48px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .toggle-buttons {
            display: flex;
            gap: 5px;
        }
        .toggle-btn {
            padding: 2px 4px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            color: #333;
        }
        .toggle-btn.active {
            background: #4a90e2;
            border-color: #357abd;
            color: white;
        }
        #plot {
            width: 100%;
            height: 400px;
        }
    </style>

    <div id="plot"></div>

    <div class="controls-container">
        <label>x₁:</label>
        <input
            type="range"
            id="slider-x1"
            min="0"
            max="20"
            step="0.01"
            value="7"
        />
        <div class="value" id="label-x1">7.00</div>
        <div style="flex-grow: 1"></div>
        <div class="toggle-buttons">
            <button class="toggle-btn" id="btn-low" data-value="low">
                Low x₂
            </button>
            <button
                class="toggle-btn active"
                id="btn-median"
                data-value="median"
            >
                Median x₂
            </button>
            <button class="toggle-btn" id="btn-high" data-value="high">
                High x₂
            </button>
        </div>
        <div class="value" id="label-x2">5</div>
    </div>

    <p>Expected payoff f₁(x₁, x₂): <span id="payoff">0.000</span></p>

    <script>
        // Distribution parameters
        const mu = 10,
            sigma = 2;

        // jStat provides normal.pdf(x, mean, sd) and normal.cdf(x, mean, sd)
        function pdf(x) {
            return jStat.normal.pdf(x, mu, sigma);
        }
        function cdf(x) {
            return jStat.normal.cdf(x, mu, sigma);
        }

        // grid for plotting
        const xs = Array.from({ length: 400 }, (_, i) => i * 0.05); // 0..19.95
        const pdfVals = xs.map(pdf);
        const maxPdf = Math.max(...pdfVals);

        // initial guesses
        let x1 = parseFloat(document.getElementById("slider-x1").value);
        let x2 = mu; // start with median x2 (1 sd above mean)

        function payoff(x1, x2) {
            if (x1 > x2) return 1 - cdf(x1);
            if (x1 < x2) return cdf(x2) - cdf(x1);
            return 0;
        }

        function buildRegionTrace(x1, x2) {
            // Return a well-formed Plotly trace even when empty so plotly doesn't complain
            if (x1 < x2) {
                const rx = xs.filter((v) => v >= x1 && v <= x2);
                return {
                    x: rx,
                    y: rx.map(pdf),
                    type: "scatter",
                    mode: "lines",
                    fill: "tozeroy",
                    fillcolor: "rgba(0,0,255,0.25)",
                    line: { color: "transparent" },
                    name: "x₁ wins",
                };
            } else if (x1 > x2) {
                const rx = xs.filter((v) => v >= x1);
                return {
                    x: rx,
                    y: rx.map(pdf),
                    type: "scatter",
                    mode: "lines",
                    fill: "tozeroy",
                    fillcolor: "rgba(0,0,255,0.25)",
                    line: { color: "transparent" },
                    name: "x₁ wins",
                };
            }
            // empty region
            return {
                x: [],
                y: [],
                type: "scatter",
                mode: "lines",
                name: "x₁ wins",
                visible: false,
            };
        }

        function updatePlot() {
            // update labels & payoff
            document.getElementById("label-x1").textContent = x1.toFixed(2);
            document.getElementById("label-x2").textContent = x2.toFixed(2);
            document.getElementById("payoff").textContent = payoff(
                x1,
                x2,
            ).toFixed(3);

            const tracePDF = {
                x: xs,
                y: pdfVals,
                type: "scatter",
                mode: "lines",
                name: "PDF",
                line: { color: "gray" },
            };

            const region = buildRegionTrace(x1, x2);

            const lineX1 = {
                x: [x1, x1],
                y: [0, maxPdf * 1.05],
                mode: "lines",
                name: "x₁",
                line: { color: "blue", width: 2 },
            };
            const lineX2 = {
                x: [x2, x2],
                y: [0, maxPdf * 1.05],
                mode: "lines",
                name: "x₂",
                line: { color: "red", width: 2 },
            };

            const layout = {
                margin: { t: 20, b: 40 },
                showlegend: false,
                xaxis: { title: "Value" },
                yaxis: { title: "PDF" },
            };

            // Use Plotly.react to efficiently update the plot
            Plotly.react("plot", [tracePDF, region, lineX1, lineX2], layout, {
                responsive: true,
                staticPlot: true,
            });
        }

        // wire up slider
        document.getElementById("slider-x1").addEventListener("input", (e) => {
            x1 = parseFloat(e.target.value);
            updatePlot();
        });

        // wire up toggle buttons
        document.getElementById("btn-low").addEventListener("click", (e) => {
            x2 = mu - sigma; // 1 sd below mean
            document.getElementById("btn-low").classList.add("active");
            document.getElementById("btn-median").classList.remove("active");
            document.getElementById("btn-high").classList.remove("active");
            updatePlot();
        });

        document.getElementById("btn-median").addEventListener("click", (e) => {
            x2 = mu;
            document.getElementById("btn-low").classList.remove("active");
            document.getElementById("btn-median").classList.add("active");
            document.getElementById("btn-high").classList.remove("active");
            updatePlot();
        });

        document.getElementById("btn-high").addEventListener("click", (e) => {
            x2 = mu + sigma; // 1 sd above mean
            document.getElementById("btn-high").classList.add("active");
            document.getElementById("btn-median").classList.remove("active");
            document.getElementById("btn-low").classList.remove("active");
            updatePlot();
        });

        // initial render
        updatePlot();
    </script>
</div>
